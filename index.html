<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Fruit Slot - Account System</title>

<link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">

<style>
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  -webkit-user-select: none;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
  outline: none;
}

body{
  width:100vw;
  height:100vh;
  overflow:hidden;
  touch-action: none; 
  background:
    linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.8)),
    url(https://files.catbox.moe/thagc5.jpg);
  background-size:cover;
  background-position:center;
  display:flex;
  justify-content:center;
  align-items:center;
  font-family: 'Segoe UI', Arial, sans-serif;
}

/* MODAL SYSTEM STYLE */
.custom-modal-overlay {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.85);
  z-index: 5000;
  display: none; 
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(8px);
}

.modal-card {
  background: #222;
  padding: 25px;
  border-radius: 15px;
  border: 3px solid #ffd700;
  width: 90%;
  max-width: 320px;
  text-align: center;
  box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
}

.modal-card h3 {
  color: #ffd700;
  font-family: 'Bangers', cursive;
  font-size: 1.8rem;
  margin-bottom: 15px;
}

.modal-card p {
  color: #fff;
  margin-bottom: 20px;
  font-size: 1rem;
  line-height: 1.4;
}

.modal-btns {
  display: flex;
  gap: 10px;
}

#login-overlay {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: 
    linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.9)),
    url(https://files.catbox.moe/thagc5.jpg);
  background-size: cover;
  background-position: center;
  z-index: 1000;
  display: flex;
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(10px);
}

#insufficient-coins-overlay {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.95);
  z-index: 2000;
  display: none; 
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(5px);
}

.login-card, .status-card {
  background: rgba(34,34,34,0.9);
  padding: 30px;
  border-radius: 15px;
  border: 3px solid #ffd700;
  width: 90%;
  max-width: 350px;
  text-align: center;
}

.login-card h2, .status-card h2 {
  color: #ffd700;
  font-family: 'Bangers', cursive;
  font-size: 2rem;
  margin-bottom: 20px;
}

.status-card p {
  color: #fff;
  margin-bottom: 20px;
  font-size: 1rem;
}

.login-card input, .status-card input, .status-card select {
  width: 100%;
  padding: 12px;
  margin: 10px 0;
  border-radius: 8px;
  border: none;
  font-size: 1rem;
}

.login-card button, .btn-admin, .btn-close-modal, .btn-menu, .btn-confirm {
  width: 100%;
  padding: 12px;
  margin-top: 15px;
  border-radius: 8px;
  border: none;
  background: #ffd700;
  font-weight: bold;
  cursor: pointer;
  font-family: 'Bangers', cursive;
  font-size: 1.2rem;
  text-decoration: none;
  display: inline-block;
  color: #000;
}

.btn-confirm-yes { background: #25D366; color: white; }
.btn-confirm-no { background: #ff4444; color: white; }
.btn-admin { background: #25D366; color: white; }
.btn-close-modal { background: #444; color: white; margin-top: 10px; }
.btn-menu { background: #333; color: #ffd700; border: 1px solid #ffd700; margin-top: 10px; }
.login-card p#error-msg { color: #ff4444; font-size: 0.8rem; margin-top: 10px; display: none; }

.main-container { 
  display: none; 
  flex-direction: column; 
  align-items: center; 
  justify-content: center; 
  width: 100%; 
  position: relative; 
  transform: translateY(-5vh); 
}

.header { 
  position: absolute; 
  top: -21.5vh; 
  width: 95%; 
  display: flex; 
  justify-content: space-between; 
  align-items: flex-start; 
}

.left-group { display: flex; flex-direction: column; gap: 5px; }
.header-box { background: rgba(0, 0, 0, 0.85); padding: 8px 12px; border-radius: 10px; border: 2px solid #ffd700; color: #ffd700; display: flex; align-items: center; gap: 8px; font-family: 'Bangers', cursive; font-size: 0.95rem; letter-spacing: 1px; }

.admin-btn { display: none; cursor: pointer; color: #ff4444 !important; border-color: #ff4444 !important; }
.logout-btn { cursor: pointer; color: #ff4444 !important; border-color: #ff4444 !important; }

.status-info { color: #fff; margin-top: 60px; margin-bottom: 1.5vh; height: 25px; text-transform: uppercase; font-family: 'Bangers', cursive; letter-spacing: 1px; }

#admin-message-banner {
  position: absolute;
  top: -35px !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  background: #25D366;
  color: white;
  padding: 5px 20px;
  border-radius: 20px;
  font-family: 'Bangers', cursive;
  font-size: 1rem;
  box-shadow: 0 0 15px rgba(37, 211, 102, 0.6);
  display: none;
  white-space: nowrap;
  z-index: 99;
  pointer-events: none;
}

#event-banner {
  position: absolute;
  top: 10px !important; 
  left: 50% !important;
  transform: translateX(-50%);
  background: linear-gradient(90deg, #ff0000, #ff8800);
  color: white;
  padding: 5px 15px;
  border-radius: 20px;
  font-family: 'Bangers', cursive;
  font-size: 1rem;
  box-shadow: 0 0 15px #ff8800;
  display: none;
  animation: pulseFix 1s infinite alternate;
  white-space: nowrap;
  z-index: 98;
  pointer-events: none;
}

@keyframes pulseFix { from { transform: translateX(-50%) scale(1); opacity: 1; } to { transform: translateX(-50%) scale(1.05); opacity: 0.8; } }

.reels-wrapper { position: relative; display: flex; justify-content: center; align-items: center; }
.slot-machine { display: flex; gap: 12px; }
.reel { width: 28vw; max-width: 100px; height: 38vw; max-height: 135px; background: linear-gradient(180deg, #111 0%, #333 50%, #111 100%); border: 3.5px solid #ffd700; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 14vw; box-shadow: inset 0 0 20px #000; }
.win-announcement { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; z-index: 100; text-align: center; display: none; width: 100vw; }
.win-announcement.active { display: block; }
.win-text { font-family: 'Bangers', cursive; font-size: 24vw; text-transform: uppercase; letter-spacing: 2px; -webkit-text-stroke: 2px #000; }
.perfect-style { color: #ffd700; text-shadow: 4px 4px 0px #000, 0 0 30px #ffd700; animation: pop-center 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
.almost-style { color: #ffffff; text-shadow: 3px 3px 0px #000; animation: slide-center 0.5s ease-out forwards; }
.controls { margin-top: 4vh; display: flex; gap: 15px; }
.btn-spin { width: 42vw; max-width: 160px; height: 75px; border: none; border-radius: 12px; font-family: 'Bangers', cursive; cursor: pointer; box-shadow: 0 6px 0 rgba(0,0,0,0.7); display: flex; flex-direction: column; justify-content: center; align-items: center; line-height: 1.2; }
.btn-main-text { font-size: 1.4rem; }
.btn-price-text { font-size: 0.8rem; opacity: 0.9; }
.spin-1 { background: #ffd700; color: #000; }
.spin-5 { background: #ff4444; color: #fff; }
.btn-spin:active { transform: translateY(4px); box-shadow: 0 2px 0 rgba(0,0,0,0.7); }
.btn-spin:disabled { filter: grayscale(1); opacity: 0.5; }

/* MODAL PROFIL */
#profile-modal {
  display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1500; justify-content:center; align-items:center; backdrop-filter:blur(10px);
}
#profile-modal .status-card { max-width: 380px; width: 95%; border: 2px solid #ffd700; padding: 20px; }
#profile-modal select, #profile-modal input { background: #333; color: white; border: 1px solid #555; margin: 5px 0 10px; }

/* MODAL ANTREAN ADMIN */
#admin-wd-modal {
  display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:2500; justify-content:center; align-items:center;
}
#admin-wd-modal .status-card { max-width: 450px; width: 95%; border-color: #ff4444; }

@keyframes pop-center { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
@keyframes slide-center { 0% { transform: translateY(30px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
@keyframes shake { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(-8px, 5px); } 75% { transform: translate(8px, -5px); } }
</style>
</head>

<body id="main-body">

  <div id="custom-alert" class="custom-modal-overlay">
    <div class="modal-card">
      <h3 id="alert-title">INFO</h3>
      <p id="alert-msg">Pesan disini...</p>
      <button class="btn-confirm" onclick="closeAlert()">OKE</button>
    </div>
  </div>

  <div id="custom-confirm" class="custom-modal-overlay">
    <div class="modal-card">
      <h3 id="confirm-title">KONFIRMASI</h3>
      <p id="confirm-msg">Apakah Anda yakin?</p>
      <div class="modal-btns">
        <button id="confirm-yes-btn" class="btn-confirm btn-confirm-yes">YA</button>
        <button id="confirm-no-btn" class="btn-confirm btn-confirm-no">TIDAK</button>
      </div>
    </div>
  </div>

  <div id="login-overlay">
    <div class="login-card">
      <h2>SLOTTY FRUIT</h2>
      <input type="text" id="username" placeholder="Masukan Username">
      <input type="password" id="password" placeholder="Masukan Password">
      <button onclick="window.authAction('login')">LOGIN</button>
      <button onclick="window.authAction('register')" style="background: #444; color: white;">BUAT AKUN</button>
      <p id="error-msg"></p>
    </div>
  </div>

  <div id="insufficient-coins-overlay">
    <div class="status-card">
      <h2>KOIN KAMU TIDAK CUKUP</h2>
      <p>Silahkan hubungi admin untuk melakukan pengisian saldo (Top Up).</p>
      <a href="https://wa.me/628812286504?text=Halo%20Admin,%20saya%20ingin%20top%20up%20koin" target="_blank" class="btn-admin" style="background: #ff4444; display: inline-block;">HUBUNGI ADMIN</a>
      <button class="btn-close-modal" onclick="document.getElementById('insufficient-coins-overlay').style.display='none'">TUTUP</button>
    </div>
  </div>

  <div id="admin-msg-modal" class="custom-modal-overlay">
    <div class="status-card" style="border-color: #25D366;">
      <h2 style="color: #25D366;">KIRIM PESAN</h2>
      <p style="font-size: 0.8rem; color: #ccc;">Pesan ini akan muncul di banner atas semua pemain.</p>
      <input type="text" id="admin-input-msg" placeholder="Ketik pesan di sini..." maxlength="50" style="background:#333; color:#fff; border:1px solid #25D366;">
      <button class="btn-admin" onclick="window.submitAdminMessage()">KIRIM SEKARANG</button>
      <button class="btn-close-modal" onclick="document.getElementById('admin-msg-modal').style.display='none'">BATAL</button>
    </div>
  </div>

  <div id="admin-topup-modal" class="custom-modal-overlay">
    <div class="status-card" style="border-color: #25D366;">
      <h2 style="color: #25D366;">TOP UP SALDO</h2>
      <p style="font-size: 0.8rem; color: #ccc;">Masukkan data koin untuk pemain target.</p>
      <input type="text" id="topup-user" placeholder="Username Target" style="background:#333; color:#fff; border:1px solid #25D366;">
      <input type="number" id="topup-amount" placeholder="Jumlah Koin" style="background:#333; color:#fff; border:1px solid #25D366;">
      <button class="btn-admin" onclick="window.submitTopUp()" style="background:#25D366; color:#fff;">TAMBAH SEKARANG</button>
      <button class="btn-close-modal" onclick="document.getElementById('admin-topup-modal').style.display='none'">BATAL</button>
    </div>
  </div>

  <div id="profile-modal">
    <div class="status-card">
      <h2 id="profile-user-name">PLAYER NAME</h2>
      
      <div id="profile-menu">
        <button class="btn-menu" onclick="window.switchProfileView('withdraw')">TARIK SALDO</button>
        <button class="btn-menu" onclick="window.switchProfileView('history')">RIWAYAT PENARIKAN</button>
      </div>

      <div id="profile-withdraw" style="display:none; text-align: left; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-top:10px;">
          <label style="color: #ffd700; font-size: 0.8rem;">PILIH METODE:</label>
          <select id="wd-method" onchange="window.toggleOtherMethodInput()">
              <option value="DANA">DANA</option>
              <option value="GOPAY">GOPAY</option>
              <option value="OVO">OVO</option>
              <option value="LAINNYA">LAINNYA</option>
          </select>
          <input type="text" id="wd-other-name" placeholder="Nama Aplikasi/Bank" style="display:none;">
          <input type="text" id="wd-number" placeholder="Nomor HP / Tujuan">
          <input type="number" id="wd-amount" placeholder="Jumlah Koin (Min 10)">
          <button class="btn-admin" onclick="window.requestWithdraw()" style="background:#ffd700; color:#000; margin-top:10px;">KONFIRMASI</button>
          <button class="btn-close-modal" onclick="window.switchProfileView('menu')" style="background:#666;">KEMBALI</button>
      </div>

      <div id="profile-history" style="display:none; margin-top:10px; text-align:left;">
        <p style="font-family:'Bangers', cursive; color:#ffd700; font-size:1.1rem; margin-bottom:5px;">RIWAYAT:</p>
        <div id="withdraw-history" style="font-size:0.75rem; color:#ccc; max-height:200px; overflow-y:auto; padding-right:5px;">
          Belum ada riwayat.
        </div>
        <button class="btn-close-modal" onclick="window.switchProfileView('menu')" style="background:#666;">KEMBALI</button>
      </div>

      <button id="btn-final-close" class="btn-close-modal" onclick="document.getElementById('profile-modal').style.display='none'">TUTUP</button>
    </div>
  </div>

  <div id="admin-wd-modal">
    <div class="status-card">
      <h2 style="color: #ff4444;">ANTREAN PENARIKAN</h2>
      <div id="admin-wd-list" style="text-align:left; max-height:350px; overflow-y:auto; padding-right:5px;">
        </div>
      <button class="btn-close-modal" onclick="document.getElementById('admin-wd-modal').style.display='none'">TUTUP</button>
    </div>
  </div>

  <div class="main-container" id="game-ui">
    <div class="header">
      <div class="left-group">
        <div class="header-box" onclick="window.openProfile()" style="cursor:pointer; border-color: #25D366;">üë§ <span id="display-name">PLAYER</span></div>
        <div class="header-box">ü™ô <span id="balance">0</span></div>
      </div>
      <div style="display: flex; gap: 5px; flex-wrap: wrap; justify-content: flex-end; max-width: 65%;">
        <div id="wd-admin-btn" class="header-box admin-btn" onclick="window.openAdminWd()">ANTREAN</div>
        <div id="msg-admin-btn" class="header-box admin-btn" onclick="window.setAdminMessage()">PESAN</div>
        <div id="admin-panel" class="header-box admin-btn" onclick="window.processTopUp()">TOP UP</div>
        <div id="event-admin-btn" class="header-box admin-btn" onclick="window.toggleEvent()">MULAI EVENT</div>
        <div class="header-box logout-btn" onclick="window.logout()">KELUAR</div>
      </div>
    </div>

    <div id="admin-message-banner"><span id="admin-message-text"></span></div>
    <div id="event-banner">EVENT: KEBERUNTUNGAN +3%</div>
    
    <div id="status" class="status-info"></div>

    <div class="reels-wrapper">
      <div class="slot-machine">
        <div id="reel1" class="reel">üçé</div>
        <div id="reel2" class="reel">üçã</div>
        <div id="reel3" class="reel">üçá</div>
      </div>
      <div id="win-overlay" class="win-announcement">
        <span id="win-text" class="win-text"></span>
      </div>
    </div>

    <div class="controls">
      <button id="btn1" class="btn-spin spin-1" onclick="window.handleSpin(1)">
        <span class="btn-main-text">1X PUTARAN</span>
        <span class="btn-price-text">1 ü™ô</span>
      </button>
      <button id="btn5" class="btn-spin spin-5" onclick="window.handleSpin(5)">
        <span class="btn-main-text">5X PUTARAN</span>
        <span class="btn-price-text">5 ü™ô</span>
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get, set, update, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDMyXg1QyJzA7DUCF4ai8bikFKq4SkYYMI",
      authDomain: "slotty-fruit.firebaseapp.com",
      databaseURL: "https://slotty-fruit-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "slotty-fruit",
      storageBucket: "slotty-fruit.firebasestorage.app",
      messagingSenderId: "803214232154",
      appId: "1:803214232154:web:06e5e30cd5c110454ea663"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- HELPER CUSTOM MODALS ---
    window.showAlert = (msg, title = "INFO") => {
      document.getElementById('alert-title').innerText = title;
      document.getElementById('alert-msg').innerText = msg;
      document.getElementById('custom-alert').style.display = 'flex';
    };
    window.closeAlert = () => { document.getElementById('custom-alert').style.display = 'none'; };

    window.showConfirm = (msg, title = "KONFIRMASI") => {
      return new Promise((resolve) => {
        document.getElementById('confirm-title').innerText = title;
        document.getElementById('confirm-msg').innerText = msg;
        const modal = document.getElementById('custom-confirm');
        modal.style.display = 'flex';
        
        document.getElementById('confirm-yes-btn').onclick = () => {
          modal.style.display = 'none';
          resolve(true);
        };
        document.getElementById('confirm-no-btn').onclick = () => {
          modal.style.display = 'none';
          resolve(false);
        };
      });
    };

    let currentUser = null;
    let balance = 0;
    let isEventActive = false;
    const symbols = ['üçé', 'üçã', 'üçá', 'üçâ', 'üçí', 'üçì', 'üçç'];
    const reelElements = [document.getElementById('reel1'), document.getElementById('reel2'), document.getElementById('reel3')];
    const winOverlay = document.getElementById('win-overlay');
    const winText = document.getElementById('win-text');
    const statusInfo = document.getElementById('status');
    const balanceDisplay = document.getElementById('balance');
    const mainBody = document.getElementById('main-body');
    const gameUI = document.getElementById('game-ui');
    const loginOverlay = document.getElementById('login-overlay');
    const errorMsg = document.getElementById('error-msg');
    
    const adminPanel = document.getElementById('admin-panel');
    const eventAdminBtn = document.getElementById('event-admin-btn');
    const msgAdminBtn = document.getElementById('msg-admin-btn');
    const wdAdminBtn = document.getElementById('wd-admin-btn');
    const eventBanner = document.getElementById('event-banner');
    const msgBanner = document.getElementById('admin-message-banner');
    const msgText = document.getElementById('admin-message-text');

    onValue(ref(db, 'settings/isEventActive'), (snap) => {
      isEventActive = snap.val() || false;
      eventBanner.style.display = isEventActive ? 'block' : 'none';
      if(currentUser === 'admin') {
        eventAdminBtn.innerText = isEventActive ? "AKHIRI EVENT" : "MULAI EVENT";
      }
    });

    onValue(ref(db, 'settings/adminMessage'), (snap) => {
      const msg = snap.val();
      if (msg && msg.trim() !== "") {
        msgBanner.style.display = 'block';
        msgText.innerText = "ADMIN: " + msg.toUpperCase();
        setTimeout(() => msgBanner.style.display = 'none', 5000);
      } else {
        msgBanner.style.display = 'none';
      }
    });

    window.openProfile = () => {
      document.getElementById('profile-user-name').innerText = currentUser.toUpperCase();
      document.getElementById('profile-modal').style.display = 'flex';
      window.switchProfileView('menu'); 
    };

    window.switchProfileView = (view) => {
      document.getElementById('profile-menu').style.display = (view === 'menu') ? 'block' : 'none';
      document.getElementById('profile-withdraw').style.display = (view === 'withdraw') ? 'block' : 'none';
      document.getElementById('profile-history').style.display = (view === 'history') ? 'block' : 'none';
      document.getElementById('btn-final-close').style.display = (view === 'menu') ? 'block' : 'none';
      if(view === 'history') window.loadWdHistory();
    };

    window.toggleOtherMethodInput = () => {
      const method = document.getElementById('wd-method').value;
      document.getElementById('wd-other-name').style.display = (method === 'LAINNYA') ? 'block' : 'none';
    };

    window.loadWdHistory = () => {
      onValue(ref(db, 'withdrawRequests'), (snap) => {
        let html = "";
        if (snap.exists()) {
          const data = snap.val();
          Object.entries(data).reverse().forEach(([id, item]) => {
            if(item.username === currentUser) {
              const sCol = item.status === 'Proses' ? '#ffd700' : '#25D366';
              const finalMethod = item.method === 'LAINNYA' ? item.otherName : item.method;
              html += `<div style="border-bottom:1px solid #444; padding:8px 0;">
                        <b>${finalMethod}: ${item.amount} ü™ô</b> <span style="color:${sCol}">[${item.status}]</span><br>
                        <small style="opacity:0.6">${item.time} | Ke: ${item.number}</small>
                       </div>`;
            }
          });
        }
        document.getElementById('withdraw-history').innerHTML = html || "Belum ada riwayat.";
      });
    };

    window.requestWithdraw = async () => {
      const method = document.getElementById('wd-method').value;
      const otherName = document.getElementById('wd-other-name').value.trim();
      const number = document.getElementById('wd-number').value.trim();
      const amount = parseInt(document.getElementById('wd-amount').value);

      if (method === 'LAINNYA' && !otherName) {
        window.showAlert("Masukkan nama aplikasi/bank Anda!", "GAGAL");
        return;
      }
      if (!number || isNaN(amount) || amount < 10) {
        window.showAlert("Lengkapi data! Minimal 10 koin.", "GAGAL");
        return;
      }
      if (amount > balance) {
        window.showAlert("Saldo koin tidak cukup!", "GAGAL");
        return;
      }

      const confirmed = await window.showConfirm(`Menarik ${amount} ü™ô!\nSaldo akan langsung dipotong.`, "KONFIRMASI PENARIKAN");
      if (confirmed) {
        const newBal = balance - amount;
        await update(ref(db, 'users/' + currentUser), { balance: newBal });
        await push(ref(db, 'withdrawRequests'), {
          username: currentUser,
          method: method,
          otherName: otherName,
          number: number,
          amount: amount,
          status: "Proses",
          time: new Date().toLocaleString('id-ID')
        });
        window.showAlert("PENARIKAN DALAM PROSES!\nMohon tunggu 0-24 jam.", "SUKSES");
        document.getElementById('wd-number').value = "";
        document.getElementById('wd-amount').value = "";
        document.getElementById('wd-other-name').value = "";
        window.switchProfileView('menu');
      }
    };

    window.openAdminWd = () => {
      document.getElementById('admin-wd-modal').style.display = 'flex';
      onValue(ref(db, 'withdrawRequests'), (snap) => {
        let html = "";
        if (snap.exists()) {
          Object.entries(snap.val()).reverse().forEach(([id, item]) => {
            if (item.status === "Proses") {
              const finalMethod = item.method === 'LAINNYA' ? item.otherName : item.method;
              html += `<div style="background:#222; padding:10px; border-radius:8px; margin-bottom:8px; border-left:4px solid #ffd700;">
                        <b>@${item.username}</b> - ${item.amount} ü™ô<br>
                        <span style="color:#ffd700;">${finalMethod}: ${item.number}</span><br>
                        <button onclick="window.confirmWd('${id}')" style="background:#25D366; border:none; padding:5px; border-radius:4px; margin-top:5px; cursor:pointer; width:100%; font-weight:bold;">SELESAI</button>
                       </div>`;
            }
          });
        }
        document.getElementById('admin-wd-list').innerHTML = html || "Antrean kosong.";
      });
    };

    window.confirmWd = async (id) => {
      const confirmTransfer = await window.showConfirm("Sudah transfer", "ADMIN");
      if (confirmTransfer) {
        await update(ref(db, `withdrawRequests/${id}`), { status: "Selesai" });
      }
    };

    window.toggleEvent = async () => { await set(ref(db, 'settings/isEventActive'), !isEventActive); };

    // --- FITUR ADMIN: PESAN ---
    window.setAdminMessage = () => {
      document.getElementById('admin-input-msg').value = "";
      document.getElementById('admin-msg-modal').style.display = 'flex';
    };

    window.submitAdminMessage = async () => {
      const msg = document.getElementById('admin-input-msg').value.trim();
      if (!msg) { window.showAlert("Pesan tidak boleh kosong!", "GAGAL"); return; }
      await set(ref(db, 'settings/adminMessage'), msg);
      document.getElementById('admin-msg-modal').style.display = 'none';
      setTimeout(() => set(ref(db, 'settings/adminMessage'), ""), 6000);
    };

    // --- FITUR ADMIN: TOP UP (TEMA PESAN) ---
    window.processTopUp = () => {
      document.getElementById('topup-user').value = "";
      document.getElementById('topup-amount').value = "";
      document.getElementById('admin-topup-modal').style.display = 'flex';
    };

    window.submitTopUp = async () => {
      const targetUser = document.getElementById('topup-user').value.trim().toLowerCase();
      const amount = parseInt(document.getElementById('topup-amount').value);
      
      if (!targetUser || isNaN(amount) || amount <= 0) {
        window.showAlert("Lengkapi data dengan benar!", "GAGAL");
        return;
      }
      
      const userRef = ref(db, 'users/' + targetUser);
      const snapshot = await get(userRef);
      if (snapshot.exists()) {
        const currentBal = snapshot.val().balance || 0;
        const newBal = currentBal + amount;
        await update(userRef, { balance: newBal });
        document.getElementById('admin-topup-modal').style.display = 'none';
        window.showAlert(`Berhasil! Saldo ${targetUser} sekarang: ${newBal} ü™ô`, "TOP UP BERHASIL");
      } else {
        window.showAlert("User tidak ditemukan!", "ERROR");
      }
    };

    window.authAction = async (type) => {
      const user = document.getElementById('username').value.trim().toLowerCase();
      const pass = document.getElementById('password').value.trim();
      if (user.length < 3 || pass.length < 3) {
        showError("Username password minimal 3 karakter!");
        return;
      }
      const userRef = ref(db, 'users/' + user);
      const snapshot = await get(userRef);
      if (type === 'register') {
        if (snapshot.exists()) { showError("Username sudah terdaftar!"); } 
        else { await set(userRef, { password: pass, balance: 0 }); startSession(user, 0); }
      } else {
        if (snapshot.exists() && snapshot.val().password === pass) { startSession(user, snapshot.val().balance); } 
        else { showError("Username atau Password Salah!"); }
      }
    };

    function showError(msg) { errorMsg.innerText = msg; errorMsg.style.display = 'block'; }

    function startSession(user, bal) {
      currentUser = user; balance = bal;
      loginOverlay.style.display = 'none'; gameUI.style.display = 'flex';
      document.getElementById('display-name').innerText = currentUser.toUpperCase();
      if (currentUser === 'admin') {
        adminPanel.style.display = 'flex'; eventAdminBtn.style.display = 'flex';
        msgAdminBtn.style.display = 'flex'; wdAdminBtn.style.display = 'flex';
      }
      onValue(ref(db, `users/${currentUser}/balance`), (snap) => {
        balance = snap.val() || 0; balanceDisplay.innerText = balance;
      });
    }

    window.logout = () => location.reload();

    let isSpinning = false;
    window.handleSpin = async (times) => {
      if (isSpinning) return;
      if (balance < times) { document.getElementById('insufficient-coins-overlay').style.display = 'flex'; return; }
      isSpinning = true;
      document.querySelectorAll('.btn-spin').forEach(b => b.disabled = true);
      balance -= times;
      await update(ref(db, 'users/' + currentUser), { balance: balance });
      for (let i = 0; i < times; i++) {
        statusInfo.innerText = times > 1 ? `BERPUTAR ${i+1}/${times}` : "BERPUTAR...";
        await runSpinAnimation();
        const winAmount = checkWin();
        if (winAmount > 0) {
            balance += winAmount;
            await update(ref(db, 'users/' + currentUser), { balance: balance });
            if(winAmount === 10) {
                mainBody.style.animation = 'shake 0.4s ease-in-out';
                setTimeout(() => mainBody.style.animation = '', 400);
            }
            showWinAnimation(winAmount);
            await new Promise(r => setTimeout(r, 2500)); 
        } else { await new Promise(r => setTimeout(r, 500)); }
        statusInfo.innerText = "";
      }
      isSpinning = false;
      document.querySelectorAll('.btn-spin').forEach(b => b.disabled = false);
    };

    function runSpinAnimation() {
      const acak = Math.random();
      let hasilAkhir = [];
      let pPerfect = isEventActive ? 0.25 : 0.20; 
      let pAlmost = isEventActive ? 0.35 : 0.30;  
      if (acak < pPerfect) { 
        const s = symbols[Math.floor(Math.random() * symbols.length)];
        hasilAkhir = [s, s, s];
      } else if (acak < pAlmost) {
        const s1 = symbols[Math.floor(Math.random() * symbols.length)];
        let s2 = symbols[Math.floor(Math.random() * symbols.length)];
        while(s1 === s2) s2 = symbols[Math.floor(Math.random() * symbols.length)];
        const pos = Math.floor(Math.random() * 3);
        if (pos === 0) hasilAkhir = [s1, s1, s2]; else if (pos === 1) hasilAkhir = [s2, s1, s1]; else hasilAkhir = [s1, s2, s1];
      } else {
        let shuffle = [...symbols].sort(() => 0.5 - Math.random());
        while(shuffle[0] === shuffle[1] || shuffle[1] === shuffle[2] || shuffle[0] === shuffle[2]) { shuffle = [...symbols].sort(() => 0.5 - Math.random()); }
        hasilAkhir = [shuffle[0], shuffle[1], shuffle[2]];
      }
      return new Promise(resolve => {
        let count = 0;
        const interval = setInterval(() => {
          reelElements.forEach(r => r.innerText = symbols[Math.floor(Math.random()*symbols.length)]);
          count++;
          if (count > 12) { clearInterval(interval); reelElements.forEach((r, i) => r.innerText = hasilAkhir[i]); resolve(); }
        }, 70);
      });
    }

    function checkWin() {
      const res = reelElements.map(el => el.innerText);
      if (res[0] === res[1] && res[1] === res[2]) return 10;
      if (res[0] === res[1] || res[1] === res[2] || res[0] === res[2]) return 4;
      return 0;
    }

    function showWinAnimation(amount) {
      winOverlay.classList.remove('active'); winText.classList.remove('perfect-style', 'almost-style');
      void winOverlay.offsetWidth;
      if (amount >= 10) { winText.innerText = "PERFECT"; winText.classList.add('perfect-style'); }
      else { winText.innerText = "ALMOST"; winText.classList.add('almost-style'); }
      winOverlay.classList.add('active');
      setTimeout(() => { winOverlay.classList.remove('active'); }, 2200);
    }
  </script>
</body>
</html>
